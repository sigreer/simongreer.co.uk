#!/usr/bin/env node
/**
 * Web Vitals collection helper.
 *
 * Generates a small HTML snippet that can be injected into a page for
 * RUM-style (Real User Monitoring) collection of Core Web Vitals using
 * the web-vitals library from CDN.
 *
 * This is a helper for manual testing, not automated CI.
 *
 * Usage:
 *   node scripts/bench/run-web-vitals.mjs --output snippet.html
 *   node scripts/bench/run-web-vitals.mjs                          # prints to stdout
 */

import { writeFileSync } from 'node:fs';

// ---------------------------------------------------------------------------
// CLI argument parsing
// ---------------------------------------------------------------------------

function parseArgs(argv) {
  const args = {
    output: null,
    endpoint: '',
    help: false,
  };

  for (let i = 2; i < argv.length; i++) {
    const arg = argv[i];
    switch (arg) {
      case '--output':
      case '-o':
        args.output = argv[++i];
        break;
      case '--endpoint':
        args.endpoint = argv[++i];
        break;
      case '--help':
      case '-h':
        args.help = true;
        break;
      default:
        console.error(`Unknown argument: ${arg}`);
        process.exit(1);
    }
  }

  return args;
}

function printHelp() {
  console.log(`
run-web-vitals.mjs - Web Vitals RUM snippet generator

USAGE
  node scripts/bench/run-web-vitals.mjs [options]

OPTIONS
  --output, -o <file>    Write snippet to a file instead of stdout
  --endpoint <url>       Optional endpoint URL to beacon results to
  -h, --help             Show this help message

DESCRIPTION
  Generates an HTML <script> snippet that uses the web-vitals library
  (loaded from CDN) to capture Core Web Vitals metrics in real user
  browsers. The snippet logs metrics to the console and optionally
  beacons them to a remote endpoint.

  Inject this snippet before </body> in any page you want to monitor.

EXAMPLES
  node scripts/bench/run-web-vitals.mjs > snippet.html
  node scripts/bench/run-web-vitals.mjs --output snippet.html
  node scripts/bench/run-web-vitals.mjs --endpoint https://analytics.example.com/vitals
`);
}

// ---------------------------------------------------------------------------
// Snippet generation
// ---------------------------------------------------------------------------

function generateSnippet(endpoint) {
  const beaconCode = endpoint
    ? `
    // Beacon results to remote endpoint
    function sendToEndpoint(metric) {
      const body = JSON.stringify({
        name: metric.name,
        value: metric.value,
        rating: metric.rating,
        delta: metric.delta,
        id: metric.id,
        navigationType: metric.navigationType,
        url: window.location.href,
        timestamp: new Date().toISOString(),
        userAgent: navigator.userAgent,
      });

      if (navigator.sendBeacon) {
        navigator.sendBeacon('${endpoint}', body);
      } else {
        fetch('${endpoint}', {
          method: 'POST',
          body,
          headers: { 'Content-Type': 'application/json' },
          keepalive: true,
        });
      }
    }`
    : '';

  const callbackName = endpoint ? 'handleMetric' : 'logMetric';
  const callbackBody = endpoint
    ? `
    function handleMetric(metric) {
      logMetric(metric);
      sendToEndpoint(metric);
    }`
    : '';

  return `<!-- Web Vitals RUM Collection Snippet -->
<!-- Generated by scripts/bench/run-web-vitals.mjs -->
<script type="module">
  import { onCLS, onFCP, onINP, onLCP, onTTFB } from 'https://unpkg.com/web-vitals@4/dist/web-vitals.attribution.js?module';

  // Store collected metrics for inspection
  window.__WEB_VITALS__ = {};

  function logMetric(metric) {
    const rating = metric.rating;
    const style = rating === 'good'
      ? 'color: #0cce6b; font-weight: bold'
      : rating === 'needs-improvement'
        ? 'color: #ffa400; font-weight: bold'
        : 'color: #ff4e42; font-weight: bold';

    console.log(
      '%c[Web Vitals] %c%s %c%s %c(%s)',
      'color: #6b7280',
      style, metric.name,
      'color: inherit', metric.value.toFixed(metric.name === 'CLS' ? 4 : 0),
      'color: #9ca3af', rating
    );

    // Store for programmatic access
    window.__WEB_VITALS__[metric.name] = {
      value: metric.value,
      rating: metric.rating,
      delta: metric.delta,
      id: metric.id,
      entries: metric.entries,
    };

    // Dispatch custom event for integration with other tools
    window.dispatchEvent(new CustomEvent('web-vital', { detail: metric }));
  }
${beaconCode}${callbackBody}

  // Register all metric observers
  onCLS(${callbackName});
  onFCP(${callbackName});
  onINP(${callbackName});
  onLCP(${callbackName});
  onTTFB(${callbackName});

  console.log('%c[Web Vitals] %cCollecting metrics...', 'color: #6b7280', 'color: inherit');
  console.log('%c[Web Vitals] %cAccess results via window.__WEB_VITALS__', 'color: #6b7280', 'color: #9ca3af');
</script>`;
}

// ---------------------------------------------------------------------------
// Main
// ---------------------------------------------------------------------------

function main() {
  const args = parseArgs(process.argv);

  if (args.help) {
    printHelp();
    process.exit(0);
  }

  const snippet = generateSnippet(args.endpoint);

  if (args.output) {
    writeFileSync(args.output, snippet);
    console.error(`Snippet written to ${args.output}`);
  } else {
    console.log(snippet);
  }
}

main();
