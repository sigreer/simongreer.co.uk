name: Deploy Bench Branch

on:
  push:
    branches: [ 'bench/*' ]

jobs:
  deploy:
    name: Build & Deploy to Bench Project
    runs-on: ubuntu-latest
    environment: simongreercouk
    permissions:
      contents: read
      deployments: write
    outputs:
      deployment-url: ${{ steps.cloudflare-deploy.outputs.deployment-url }}
      branch-name: ${{ steps.extract-branch.outputs.branch }}

    steps:
      - uses: actions/checkout@v4

      - name: Extract branch name
        id: extract-branch
        run: echo "branch=${GITHUB_REF#refs/heads/}" >> "$GITHUB_OUTPUT"

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install

      - name: Build site
        env:
          MAILTRAP_API_KEY: ${{ secrets.MAILTRAP_API_KEY }}
          MAILTRAP_API_USER: ${{ secrets.MAILTRAP_API_USER }}
          MAILTRAP_FROM_EMAIL: ${{ secrets.MAILTRAP_FROM_EMAIL }}
          MAILTRAP_HOST: ${{ vars.MAILTRAP_HOST }}
          MAILTRAP_PORT: ${{ vars.MAILTRAP_PORT }}
          MAILTRAP_TO_EMAIL: ${{ secrets.MAILTRAP_TO_EMAIL }}
          SITE_URL: ${{ vars.SITE_URL }}
        run: bun run astro build

      - name: Deploy to Cloudflare Pages (Bench)
        id: cloudflare-deploy
        uses: cloudflare/wrangler-action@v3
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          command: pages deploy dist --project-name=simongreer-bench --branch=${{ steps.extract-branch.outputs.branch }}

  smoke-test:
    name: Smoke Test Deployment
    needs: deploy
    runs-on: ubuntu-latest
    steps:
      - name: Wait for deployment to propagate
        run: sleep 15

      - name: Check deployment responds with 200
        run: |
          DEPLOY_URL="${{ needs.deploy.outputs.deployment-url }}"
          echo "Smoke testing: $DEPLOY_URL"
          STATUS=$(curl -o /dev/null -s -w "%{http_code}" --retry 3 --retry-delay 5 "$DEPLOY_URL")
          echo "HTTP status: $STATUS"
          if [ "$STATUS" -ne 200 ]; then
            echo "Smoke test failed â€” expected 200, got $STATUS"
            exit 1
          fi
          echo "Smoke test passed"
